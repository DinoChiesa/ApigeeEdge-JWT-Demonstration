# JWT Verification - token generated by Okta

This API proxy validates a JWT that was created and signed by Okta.

This proxy will work on the Apigee Edge public cloud release.

## Deploying

Several notes:

* use a tool like [apigeetool](https://github.com/apigee/apigeetool-node) or [pushapi](https://github.com/carloseberhardt/apiploy) or
[importAndDeploy.js](https://github.com/DinoChiesa/apigee-edge-js/blob/master/examples/importAndDeploy.js) 
to deploy the proxy.

* Before you deploy the proxy you need to create a cache on the
environment. The cache should be named 'cache1'.

## Invoking

To generate tokens from Okta, you will need an [Okta tenant](https://developer.okta.com/), and you will need to [configure an authorization server](https://developer.okta.com/authentication-guide/implementing-authentication/set-up-authz-server) on that tenant.

To verify a token generated by Okta, use this curl command:

```
  curl -i -X POST http://myorg-test.apigee.net/jwt-verify-okta/test -H "Authorization: Bearer $jwt"

```

This validation uses the Okta keys obtained from [the well-known public endpoint](https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7/.well-known/oauth-authorization-server) for your Okta tenant.

To actually obtain a JWT generated by Okta, you need create an OIDC client in your Okta tenant and then sign in against that OIDC client. Read about creating an OIDC client [here](https://help.okta.com/en/prev/Content/Topics/Apps/Apps_App_Integration_Wizard.htm).

The Okta flow has been set up to take advantage of Okta's API Access Management capabilities. Using Okta, you can mint access tokens (jwts) that have specific OAuth scopes for specific users. These assignments can be based on a variety of factors in the user context - group membership, for example.

There are three proxy endpoints included in this flow:
http://myorg-test.apigee.net/jwt-verify-okta/test
-- if the jwt is valid: responds with an "OK" status and a few fields parsed from the jwt

http://myorg-test.apigee.net/jwt-verify-okta/planets
-- if the jwt is valid AND includes the scope "http://myapp.com/scp/silver" then the request will be passed on to the target endpoint

http://myorg-test.apigee.net/jwt-verify-okta/moons
-- if the jwt is valid AND includes the scope "http://myapp.com/scp/gold" then the request will be passed on to the target endpoint

You can find out more about setting up an authorization server with Okta [here](https://developer.okta.com/authentication-guide/implementing-authentication/set-up-authz-server)

## Commentary

The JWT Verification policy in Apigee Edge is smart enough to extract keys from a JWK set. The authorization server on your Okta tenant [exposes a JWK set](https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7/v1/keys). This endpoint provides the public keys that correspond to the private keys used by Okta to sign JWT.  Each public key is identified by a "key ID", aka "kid". The content available at this endpoint changes as Okta rotates keys, but a typical response looks like this:

```json
{
  "keys":
  [
    {
      "alg":"RS256",
      "e":"AQAB",
      "n":"gRynnM4G-MEzCIh6RXZSderUazMYtgTAfGALStft-K8uA0HuszH0eg3p9lqSyiYP3dXRKXBRZkcvKri_xpkXBihwnXJ24O493gnalCWQ08rsguRclcuG9EHyIPJ1lm93ZWNtImSkwDCZu1ikC6epfVODO6LOBbXRyHNMJrue7Bl2vYoLZeQTw0L5TyEofnIKEjS2-Gk07SqLDe3NlWnWHN88A9fKaZEVsmGkAo9QTyfwtOEZt6ROE0VpNwmyii5CDWFDpGDAzWWFghPD3t_hkANGMX709s3JLMeXZjTSXzaYcDECWwErvMWLx-BUvEbZvOfuFgwl32hVyYpM6aQSsQ",
      "kid":"h4U09qoCKSwyI-G7zustzn68X2eMt8QdV3sU6USTfrk",
      "kty":"RSA",
      "use":"sig"
    },
    {
      "alg":"RS256",
      "e":"AQAB",
      "n":"iLzthtqV18UL1kRNEfAJE_CizNGKnINIPOXqHZ0y1kNOzBkgnaNsqkYj4xkzmITfSqcFdnt-bJQVFzXXsoAsgoa7DLtuYVWSmunMxk806wikqFYD7kwmg1nQHh4pSFsIOtEciGs3ZY7r9dxkR1uN6J68eDscKQc-EM7kiPrXb_ByM_fYYgFUeBhc5ftv4ZEZfUAQrPNnEgI66ZyyUqSLnIJLajDwzypIU4mfVFXioYTzWMvxlnVssu1_Mb6aIob8eXEDFT_XxIRiP869KLporKDPARhFxXNEpgpRNVJ5CzjiIDeIigeIYhzbSDmBjgLjSYm00P25PKuvuYof8Pfs4w",
      "kid":"RFJeRbdOQmLxR_Q5pKe75MxOR_XzoNFkCH7EpzSA50c",
      "kty":"RSA",
      "use":"sig"
    }
  ]
}
```

The API Proxy uses a ServiceCallout to perform a GET on that URL, and then caches the result for one hour. Then, verification can be configured like this:

```xml
<VerifyJWT name="Verify-JWT-1">
    <Algorithm>RS256</Algorithm>
    <Source>inbound.jwt</Source>
    <PublicKey>
      <JWKS ref='cached.okta.jwks'/>
    </PublicKey>
    <Issuer>https://partnerpoc.oktapreview.com/oauth2/ausce8ii5wBzd0zvQ0h7</Issuer>
</VerifyJWT>
```

Just update the <Issuer> value with the appropriate url for you Okta tenant and authorization server ID.

Simple!
